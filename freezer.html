{% extends "layout.html" %}
{% block content %}
<style>
    /* åŸºç¤ä½ˆå±€ï¼šé™åˆ¶é é¢é«˜åº¦ç‚ºè¦–çª—çš„ 85%ï¼Œä¸¦ä½¿ç”¨å½ˆæ€§ä½ˆå±€ */
    .freezer-page { height: 85vh; display: flex; flex-direction: column; gap: 15px; }
    .main-layout { display: flex; gap: 20px; flex: 1; min-height: 0; }

    /* å·¦å³åˆ†æµç¾¤çµ„æ¨£å¼ï¼šåˆ†ç‚ºã€Œä½¿ç”¨ä¸­ã€èˆ‡ã€Œå¯å€Ÿç”¨ã€å…©å€ */
    .status-group { flex: 1; border-radius: 20px; border: 1px solid #eee; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
    .group-inuse { background-color: #fffaf0; border-color: #fbd38d; } /* ä½¿ç”¨ä¸­å€åŸŸèƒŒæ™¯ç‚ºç±³é»ƒè‰² */
    .group-available { background-color: #ebf8ff; border-color: #90cdf4; } /* å¯å€Ÿç”¨å€åŸŸèƒŒæ™¯ç‚ºæ·¡è—è‰² */

    .status-title { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: bold; margin-bottom: 12px; color: #4a5568; }
    .dot { width: 4px; height: 16px; border-radius: 2px; }

    /* ç¶²æ ¼ç³»çµ±ï¼šå¼·åˆ¶æ¯ä¸€æ’é¡¯ç¤º 7 å€‹ç›’å­ */
    .box-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; overflow-y: auto; padding: 5px; }

    /* ç›’å­æ–¹å¡ŠåŸºç¤æ¨£å¼ */
    .box-square {
        aspect-ratio: 1/1; border-radius: 12px; border: 1.5px solid #e2e8f0;
        position: relative; display: flex; flex-direction: column;
        align-items: center; justify-content: center; padding: 5px;
        transition: transform 0.1s; background: #ffffff; text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    .box-square:hover { transform: translateY(-2px); z-index: 5; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    /* --- æ ¸å¿ƒé‚è¼¯ï¼šé¡è‰²è­˜åˆ¥æ¨™ç±¤ (å·²ä¿®æ”¹ç‚ºç™¾åˆ†æ¯”ç¸®æ”¾) --- */
    .color-indicator { 
        position: absolute; 
        top: 6%; 
        right: 6%; 
        width: 12%; 
        height: 12%; 
        border-radius: 50%; 
        border: 1px solid rgba(0,0,0,0.1); 
        background-color: #cbd5e0 !important; 
        z-index: 3;
    }
    /* é€™è£¡ä½¿ç”¨äº†å±¬æ€§é¸å–å™¨ data-name^="å­—æ¯" (ä¸åˆ†å¤§å°å¯« i) */
    .box-square[data-name^="r" i] .color-indicator { background-color: #f56565 !important; }
    .box-square[data-name^="y" i] .color-indicator { background-color: #f6e05e !important; }
    .box-square[data-name^="b" i] .color-indicator { background-color: #4299e1 !important; }
    .box-square[data-name^="g" i] .color-indicator { background-color: #48bb78 !important; }
    .box-square[data-name^="o" i] .color-indicator { background-color: #ed8936 !important; }
    .box-square[data-name^="c" i] .color-indicator { background-color: #00ced1 !important; }
    .box-square[data-name^="m" i] .color-indicator { background-color: #ed64a6 !important; }
    .box-square[data-name^="k" i] .color-indicator { background-color: #2d3748 !important; }
    .box-square[data-name^="w" i] .color-indicator { background-color: #ffffff !important; border: 1px solid #cbd5e0; }

    /* ç›’å­å…§æ–‡å­—æ¨£å¼ */
    .box-name { font-size: 14px; font-weight: 800; color: #2d3748; }
    .box-user { font-size: 12px; color: #4a5568; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 90%; margin-top: 2px; }
    .day-info { font-size: 10px; margin-top: 3px; transform: scale(0.95); }
    .text-overdue { color: #c53030; font-weight: 900; } /* é€¾æœŸå¤©æ•¸é¡¯ç¤ºç´…è‰² */
    .text-safe { color: #2f855a; font-weight: 600; }    /* æ­£å¸¸å¤©æ•¸é¡¯ç¤ºç¶ è‰² */

    /* é€¾æœŸå‹•ç•«ï¼šç•¶å€Ÿç”¨è¶…é 7 å¤©æ™‚æœƒå‘ˆç¾ç´…æ¡†é–ƒçˆè­¦ç¤º */
    @keyframes alarm-blink { 0% { border-color: #e2e8f0; } 50% { border-color: #f56565; box-shadow: 0 0 10px rgba(245,101,101,0.4); } 100% { border-color: #e2e8f0; } }
    .is-overdue { animation: alarm-blink 1.5s infinite; border-width: 2.5px !important; }
    
    /* è¦†è“‹å±¤æŒ‰éˆ•ï¼šè®“æ•´å€‹æ–¹å¡Šéƒ½å¯ä»¥è¢«é»æ“Šï¼Œè€Œä¸å½±éŸ¿å…§æ–‡æ’ç‰ˆ */
    .overlay-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; border: none; cursor: pointer; z-index: 2; }

    /* åº•éƒ¨ç®¡ç†é¢æ¿ä¿®æ­£ (æ‘ºç–Šé¢æ¿å¼è¨­è¨ˆ) */
    .admin-details { margin-top: 15px; border-radius: 15px; background: #edf2f7; border: 1px solid #cbd5e0; flex-shrink: 0; }
    .admin-summary { padding: 12px 20px; background: #e2e8f0; cursor: pointer; font-size: 15px; font-weight: bold; color: #2d3748; list-style: none; display: flex; justify-content: space-between; border-radius: 15px; }
    .admin-details[open] .admin-summary { border-radius: 15px 15px 0 0; }
    
    .admin-content { padding: 15px; display: flex; flex-direction: column; gap: 15px; max-height: 220px; overflow-y: auto; }
    .add-form { display: flex; gap: 10px; justify-content: center; padding-bottom: 10px; border-bottom: 1px solid #cbd5e0; }
    .admin-input { padding: 8px 15px; border-radius: 8px; border: 1px solid #cbd5e0; width: 450px; }
    
    /* ç®¡ç†æ¸…å–®ç¶²æ ¼ */
    .box-manager-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
    .manage-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .btn-del-text { background: none; border: none; color: #e53e3e; cursor: pointer; font-weight: bold; font-size: 18px; }
</style>

<div class="freezer-page">
    <div class="main-layout">
        <div class="status-group group-inuse">
            <div class="status-title">
                <div class="dot" style="background: #ecc94b;"></div>
                ä½¿ç”¨ä¸­ In Use ({{ in_use_boxes|length }})
            </div>
            <div class="box-grid">
                {% for b in in_use_boxes %}
                <div class="box-square {{ 'is-overdue' if b.days_used >= 7 }}" data-name="{{ b.box_name }}">
                    <div class="color-indicator"></div>
                    <div class="box-name">{{ b.box_name }}</div>
                    <div class="box-user">{{ b.user_name }}</div>
                    <div class="day-info">
                        {% if b.days_used >= 7 %}
                            <span class="text-overdue">é€¾æœŸ Overdue {{ b.overdue_days }}d</span>
                        {% else %}
                            <span class="text-safe">å·²å€Ÿ Used {{ b.days_used }}d</span>
                        {% endif %}
                    </div>
                    <form method="POST" onsubmit="return confirm('ç¢ºèªæ­¸é‚„ã€Œ{{ b.box_name }}ã€ï¼Ÿ \nConfirm return of box {{ b.box_name }}?')">
                        <input type="hidden" name="box_id" value="{{ b.id }}"><button type="submit" name="return_box" class="overlay-btn"></button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="status-group group-available">
            <div class="status-title">
                <div class="dot" style="background: #4299e1;"></div>
                å¯å€Ÿç”¨ Available ({{ available_boxes|length }})
            </div>
            <div class="box-grid">
                {% for b in available_boxes %}
                <div class="box-square" data-name="{{ b.box_name }}">
                    <div class="color-indicator"></div>
                    <div class="box-name">{{ b.box_name }}</div>
                    <form method="POST">
                        <input type="hidden" name="box_id" value="{{ b.id }}">
                        <button type="submit" name="use_box" class="overlay-btn" {% if not current_user %}onclick="alert('è«‹å…ˆé¸å–ä½¿ç”¨è€…ï¼ \nPlease select a user first!'); return false;"{% endif %}></button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <details class="admin-details" id="adminPanel">
        <summary class="admin-summary">
            <span>âš™ï¸ åº«å­˜æ¸…å–®ç®¡ç† Inventory Management</span>
            <span style="font-size: 12px; font-weight: normal;">(æ‰¹é‡è¼¸å…¥è«‹ç”¨é€—è™Ÿéš”é–‹ Batch input via comma, e.g., R1, R2, B1)</span>
        </summary>
        <div class="admin-content">
            <form method="POST" class="add-form">
                <input type="text" name="box_name" placeholder="R1, B2, G3..." required class="admin-input">
                <button type="submit" name="add_box" class="btn-add-box" style="background: #2d3748; color: white; padding: 8px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;">æ‰¹é‡å»ºç«‹ Batch Create</button>
            </form>
            <div class="box-manager-list">
                {% set all_boxes = in_use_boxes + available_boxes %}
                {% for b in all_boxes|sort(attribute='box_name') %}
                <div class="manage-item">
                    <span style="font-size:12px; font-weight:bold;">{{ b.box_name }}</span>
                    {% if b.user_name %}<span style="color:#a0aec0; font-size:12px;" title="ä½¿ç”¨ä¸­ In Use">ğŸ”’</span>
                    {% else %}
                    <form method="POST" onsubmit="return confirm('ç¢ºå®šåˆªé™¤ {{ b.box_name }}ï¼Ÿ \nConfirm delete box {{ b.box_name }}?')" style="margin:0;">
                        <input type="hidden" name="box_id" value="{{ b.id }}">
                        <button type="submit" name="delete_box" class="btn-del-text">Ã—</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </details>
</div>

<script>
    const adminPanel = document.getElementById('adminPanel');
    let timer;

    function startTimer() {
        clearTimeout(timer);
        if (adminPanel.open) {
            timer = setTimeout(() => { adminPanel.open = false; }, 15000);
        }
    }

    adminPanel.addEventListener('toggle', startTimer);
    ['mousemove', 'keydown', 'click'].forEach(e => adminPanel.addEventListener(e, startTimer));
</script>
{% endblock %}

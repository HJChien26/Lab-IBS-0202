{% extends "layout.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root {
        --am-base: #e1f5fe;
        --am-dark: #b3e5fc;
        --pm-base: #fff3e0;
        --pm-dark: #ffe0b2;
        --booked-bg: #e0e0e0;
        --selection-bg: #f39c12;
        --my-booking-bg: #3498db;
    }

    .ihc-container {
        padding: 20px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    .info-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 2px;
        min-width: 1100px;
        user-select: none;
    }

    th, td {
        padding: 4px;
        text-align: center;
        border-radius: 4px;
        line-height: 1.2;
    }

    .header-date {
        background: #eee;
        min-width: 85px;
        padding: 8px 4px;
        font-size: 0.9rem;
    }
    .weekend { color: #e74c3c; font-weight: bold; }

    /* æ ¼å­é«˜åº¦å„ªåŒ– */
    .slot {
        cursor: cell;
        transition: all 0.1s ease;
        height: 28px;
        border: 1px solid rgba(0,0,0,0.02);
        font-size: 0.85rem;
    }

    .am-slot { background-color: var(--am-base); }
    .pm-slot { background-color: var(--pm-base); }

    .slot.selecting { background-color: var(--selection-bg) !important; color: white; }
    .slot.booked { background-color: var(--booked-bg) !important; color: #777; cursor: not-allowed; }
    .slot.my-booking { 
        background-color: var(--my-booking-bg) !important; 
        color: white !important; 
        border: 1px solid #2980b9;
    }

    /* å´é‚Šæ¬„ä½æ¨£å¼èª¿æ•´ */
    .period-header {
        font-weight: bold;
        width: 60px;
        font-size: 0.85rem;
    }
    .period-header small { display: block; font-weight: normal; font-size: 0.7rem; opacity: 0.8; }

    .tray-header {
        font-weight: bold;
        min-width: 90px;
        font-size: 0.85rem;
    }
    .tray-header small { display: block; font-weight: normal; font-size: 0.7rem; opacity: 0.7; }

    .legend {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        font-size: 0.8rem;
        color: #555;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .box { width: 14px; height: 14px; border-radius: 3px; }
</style>

<div class="ihc-container">
    <div class="info-bar">
        <h2 style="margin:0; font-size: 1.25rem;">
            IHC æŸ“è‰²æ©Ÿé ç´„ç³»çµ±<br>
            <span style="font-size: 0.9rem; font-weight: normal; color: #666;">BOND-MAX Booking System</span>
        </h2>
        <div style="text-align: right;">
            æ“ä½œè€… Operator<br>
            <strong style="color: #2c3e50; font-size: 1.1rem;">{{ current_user or 'æœªç™»å…¥ Guest' }}</strong>
        </div>
    </div>

    <table id="ihc-table">
        <thead>
            <tr>
                <th colspan="2" style="background:#ddd; font-size: 0.8rem;">
                    æ™‚æ®µ Date<br>æ—¥æœŸ Slot
                </th>
                {% for d in dates %}
                <th class="header-date {{ 'weekend' if d.weekday() >= 5 }}">
                    {{ d.strftime('%m/%d') }}<br>
                    <small>{{ ['é€±ä¸€ Mon','é€±äºŒ Tue','é€±ä¸‰ Wed','é€±å›› Thu','é€±äº” Fri','é€±å…­ Sat','é€±æ—¥ Sun'][d.weekday()] }}</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for s in slots %}
            <tr>
                {# ç¬¬ä¸€æ¬„ï¼šä¸Šåˆ/ä¸‹åˆ #}
                {% if s == 'AM1' %}
                    <td rowspan="3" class="period-header" style="background: var(--am-dark);">
                        ä¸Šåˆ<small>AM</small>
                    </td>
                {% elif s == 'PM1' %}
                    <td rowspan="3" class="period-header" style="background: var(--pm-dark);">
                        ä¸‹åˆ<small>PM</small>
                    </td>
                {% endif %}

                {# ç¬¬äºŒæ¬„ï¼šç›¤è™Ÿ #}
                <td class="tray-header" style="background: {{ 'var(--am-base)' if 'AM' in s else 'var(--pm-base)' }};">
                    ç›¤ {{ s[-1] }}<small>Tray {{ s[-1] }}</small>
                </td>

                {# é ç´„æ–¹æ ¼ #}
                {% for d in dates %}
                    {% set d_str = d.strftime('%Y-%m-%d') %}
                    {% set occupant = booked_data.get(d_str, {}).get(s) %}
                    <td class="slot {{ 'am-slot' if 'AM' in s else 'pm-slot' }} 
                               {{ 'booked' if occupant }} 
                               {{ 'my-booking' if occupant == current_user }}"
                        data-date="{{ d_str }}" 
                        data-slot="{{ s }}">
                        {{ occupant if occupant else '' }}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="legend">
        <div class="legend-item"><div class="box" style="background:var(--am-base)"></div> ä¸Šåˆ AM</div>
        <div class="legend-item"><div class="box" style="background:var(--pm-base)"></div> ä¸‹åˆ PM</div>
        <div class="legend-item"><div class="box" style="background:var(--my-booking-bg)"></div> æˆ‘çš„é ç´„ My Booking</div>
        <div class="legend-item"><div class="box" style="background:var(--booked-bg)"></div> å·²é ç´„ Booked</div>
        <div class="legend-item">ğŸ’¡ æç¤ºï¼šæŒ‰ä½æ»‘é¼ å·¦éµä¸¦æ‹–æ›³ï¼Œå¯æ‰¹é‡é€²è¡Œé ç´„æˆ–å–æ¶ˆæ“ä½œ</div>
    </div>
</div>

<script>
// JS é‚è¼¯éƒ¨åˆ†ç¶­æŒä¸è®Š
let isDragging = false;
let selectedSlots = new Set();
let dragMode = null; 
const currentUser = "{{ current_user }}";

document.querySelectorAll('.slot').forEach(td => {
    td.onmousedown = (e) => {
        if (!currentUser || currentUser === "None") {
            Swal.fire('æç¤º', 'è«‹å…ˆè¿”å›é¦–é é¸å–å§“å \n Please select your name first', 'warning');
            return;
        }
        if (e.button !== 0) return; 

        const occupant = td.innerText.trim();
        if (!occupant) {
            dragMode = 'book';
        } else if (occupant === currentUser) {
            dragMode = 'cancel';
        } else {
            return;
        }

        isDragging = true;
        addSelection(td);
    };

    td.onmouseenter = () => {
        if (isDragging) addSelection(td);
    };
});

window.onmouseup = () => {
    if (!isDragging) return;
    isDragging = false;
    if (selectedSlots.size > 0) submitBatch();
};

function addSelection(el) {
    const occupant = el.innerText.trim();
    if ((dragMode === 'book' && !occupant) || (dragMode === 'cancel' && occupant === currentUser)) {
        const key = `${el.dataset.date}|${el.dataset.slot}`;
        el.classList.add('selecting');
        selectedSlots.add(key);
    }
}

async function submitBatch() {
    const actionText = dragMode === 'book' ? 'ç¢ºèªé ç´„ Confirm?' : 'ç¢ºèªå–æ¶ˆ Cancel?';
    const result = await Swal.fire({
        title: actionText,
        text: `é¸å–æ™‚æ®µæ•¸é‡ Selected: ${selectedSlots.size}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ç¢ºå®š OK',
        cancelButtonText: 'å–æ¶ˆ No'
    });

    if (result.isConfirmed) {
        Swal.fire({ title: 'è™•ç†ä¸­ Processing...', didOpen: () => Swal.showLoading() });
        for (let item of selectedSlots) {
            const [date, slot] = item.split('|');
            await fetch("{{ url_for('ihc_batch') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: dragMode, date: date, slot: slot })
            });
        }
        location.reload();
    } else {
        document.querySelectorAll('.selecting').forEach(el => el.classList.remove('selecting'));
        selectedSlots.clear();
    }
}
</script>
{% endblock %}

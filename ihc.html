{% extends "layout.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    :root {
        --am-base: #e1f5fe;
        --am-side: #e3f2fd; 
        --pm-base: #fff3e0;
        --pm-side: #fff8e1; 
        --booked-bg: #e0e0e0;
        --selection-bg: #f39c12;
        --my-booking-bg: #3498db;
    }

    .ihc-outer-wrapper {
        width: 98%; 
        margin: 0 auto; 
        padding: 15px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        min-height: 85vh; 
        overflow: hidden;
    }

    .info-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 10px;
        flex-shrink: 0;
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 2px; 
        user-select: none;
        table-layout: fixed; 
        flex: 1; 
    }

    thead th {
        background-color: #f2f2f2;
        border-bottom: 2px solid #ccc;
        padding: 10px 0;
    }

    th, td {
        text-align: center;
        line-height: 1.4;
        border: 1px solid #f0f0f0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .header-date {
        font-size: 1rem; 
        font-weight: bold;
    }
    .header-date small { display: block; font-size: 0.85rem; font-weight: normal; }
    .weekend { color: #e74c3c; }

    .slot {
        cursor: cell;
        transition: all 0.1s ease;
        height: 80px;  
        font-size: 0.95rem; 
    }

    .am-slot { background-color: var(--am-base); }
    .pm-slot { background-color: var(--pm-base); }

    .slot.selecting { background-color: var(--selection-bg) !important; color: white !important; }
    .slot.booked { background-color: var(--booked-bg) !important; color: #777; font-weight: bold; cursor: not-allowed; }
    .slot.my-booking { 
        background-color: var(--my-booking-bg) !important; 
        color: white !important; 
        border: 1px solid #2980b9;
    }

    .period-header { font-weight: bold; width: 50px; font-size: 1.1rem; }
    .period-am { background-color: var(--am-side); color: #0277bd; }
    .period-pm { background-color: var(--pm-side); color: #ef6c00; }

    .tray-header { font-weight: bold; width: 85px; font-size: 0.9rem; } /* ç¨å¾®åŠ å¯¬ä»¥å®¹ç´ Tray è‹±æ–‡ */
    .tray-am { background-color: var(--am-side); }
    .tray-pm { background-color: var(--pm-side); }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 15px;
        padding: 10px;
        font-size: 1rem;
        color: #555;
        flex-shrink: 0;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; }
    .box { width: 18px; height: 18px; border-radius: 4px; }
</style>

<div class="ihc-outer-wrapper">
    <div class="info-bar">
        <h2 style="margin:0; font-size: 1.6rem;">
            IHC æŸ“è‰²æ©Ÿé ç´„ç³»çµ±
            <span style="font-size: 1rem; font-weight: normal; color: #666; margin-left: 10px;">BOND-MAX Booking System</span>
        </h2>
        <div style="text-align: right;">
            æ“ä½œè€… Operator: 
            <strong style="color: #2c3e50; font-size: 1.3rem;">{{ current_user or 'æœªç™»å…¥ Guest' }}</strong>
        </div>
    </div>

    <table id="ihc-table">
        <thead>
            <tr>
                <th colspan="2" style="background:#eee; font-size: 0.9rem;">æ™‚æ®µ Slot \ æ—¥æœŸ Date</th>
                {% for d in dates %}
                <th class="header-date {{ 'weekend' if d.weekday() >= 5 }}">
                    {{ d.strftime('%m/%d') }}<br>
                    <small>{{ ['é€±ä¸€ Mon','é€±äºŒ Tue','é€±ä¸‰ Wed','é€±å›› Thu','é€±äº” Fri','é€±å…­ Sat','é€±æ—¥ Sun'][d.weekday()] }}</small>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for s in slots %}
            <tr>
                {% if s == 'AM1' %}
                    <td rowspan="3" class="period-header period-am">ä¸Šåˆ<br>AM</td>
                {% elif s == 'PM1' %}
                    <td rowspan="3" class="period-header period-pm">ä¸‹åˆ<br>PM</td>
                {% endif %}

                <td class="tray-header {{ 'tray-am' if 'AM' in s else 'tray-pm' }}">
                    æ‰˜ç›¤ {{ s[-1] }}<br>Tray {{ s[-1] }}
                </td>

                {% for d in dates %}
                    {% set d_str = d.strftime('%Y-%m-%d') %}
                    {% set occupant = booked_data.get(d_str, {}).get(s) %}
                    <td class="slot {{ 'am-slot' if 'AM' in s else 'pm-slot' }} 
                               {{ 'booked' if occupant }} 
                               {{ 'my-booking' if occupant == current_user }}"
                        data-date="{{ d_str }}" 
                        data-slot="{{ s }}">
                        {{ occupant if occupant else '' }}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="legend">
        <div class="legend-item"><div class="box" style="background:var(--am-base)"></div> ä¸Šåˆ AM</div>
        <div class="legend-item"><div class="box" style="background:var(--pm-base)"></div> ä¸‹åˆ PM</div>
        <div class="legend-item"><div class="box" style="background:var(--my-booking-bg)"></div> æˆ‘çš„é ç´„ My Booking</div>
        <div class="legend-item"><div class="box" style="background:var(--booked-bg)"></div> å·²é ç´„ Booked</div>
        <div style="margin-left: auto; color: #888;">ğŸ’¡ æç¤ºï¼šæŒ‰ä½å·¦éµä¸¦æ‹–æ›³å¯æ‰¹é‡é ç´„æˆ–å–æ¶ˆæ“ä½œ / Drag to batch booking or cancel</div>
    </div>
</div>

<script>
// JS é‚è¼¯ä¿æŒä¸è®Šï¼Œç•¥
let isDragging = false;
let selectedSlots = new Set();
let dragMode = null; 
const currentUser = "{{ current_user }}";

document.querySelectorAll('.slot').forEach(td => {
    td.onmousedown = (e) => {
        if (!currentUser || currentUser === "None") {
            Swal.fire('æç¤º', 'è«‹å…ˆè¿”å›é¦–é é¸å–å§“å \n Please select your name first', 'warning');
            return;
        }
        if (e.button !== 0) return; 

        const occupant = td.innerText.trim();
        if (!occupant) {
            dragMode = 'book';
        } else if (occupant === currentUser) {
            dragMode = 'cancel';
        } else {
            return;
        }

        isDragging = true;
        addSelection(td);
    };

    td.onmouseenter = () => {
        if (isDragging) addSelection(td);
    };
});

window.onmouseup = () => {
    if (!isDragging) return;
    isDragging = false;
    if (selectedSlots.size > 0) submitBatch();
};

function addSelection(el) {
    const occupant = el.innerText.trim();
    if ((dragMode === 'book' && !occupant) || (dragMode === 'cancel' && occupant === currentUser)) {
        const key = `${el.dataset.date}|${el.dataset.slot}`;
        el.classList.add('selecting');
        selectedSlots.add(key);
    }
}

async function submitBatch() {
    const actionText = dragMode === 'book' ? 'ç¢ºèªé ç´„ Confirm?' : 'ç¢ºèªå–æ¶ˆ Cancel?';
    const result = await Swal.fire({
        title: actionText,
        text: `é¸å–æ™‚æ®µæ•¸é‡ Selected: ${selectedSlots.size}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ç¢ºå®š OK',
        cancelButtonText: 'å–æ¶ˆ No'
    });

    if (result.isConfirmed) {
        Swal.fire({ title: 'è™•ç†ä¸­ Processing...', didOpen: () => Swal.showLoading() });
        for (let item of selectedSlots) {
            const [date, slot] = item.split('|');
            await fetch("{{ url_for('ihc_batch') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: dragMode, date: date, slot: slot })
            });
        }
        location.reload();
    } else {
        document.querySelectorAll('.selecting').forEach(el => el.classList.remove('selecting'));
        selectedSlots.clear();
    }
}
</script>
{% endblock %}

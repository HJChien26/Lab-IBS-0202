{% extends "layout.html" %}
{% block content %}
<style>
    :root {
        /* 全域樣式變數定義 */
        --border-color: #6b7280; 
        --inner-border-color: #d1d5db;

        /* 四台 BSC 預約設備的主題配色 */
        --bsc1-color: #3498db; 
        --bsc2-color: #2ecc71; 
        --bsc3-color: #f39c12; 
        --bsc4-color: #9b59b6;
        --grid-font-size: 13px;
        --now-border: #2563eb; /* 標示「現在時間」的框線顏色 */
    }

    /* 頁面整體佈局控制 */
    .full-page-wrapper {
        height: auto; 
        max-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 5px 10px 10px 10px; 
        background-color: transparent;
        box-sizing: border-box;
    }

    /* 頂部 Tab 選項卡容器 */
    .tab-container { 
        display: flex; 
        gap: 6px; 
        padding: 0 10px; 
        background: transparent; 
        margin-bottom: -1px; 
        z-index: 10;
        flex-shrink: 0;
    }

    /* Tab 基本樣式與選取效果 */
    .tab { 
        padding: 8px 24px; 
        cursor: pointer; 
        background: #f3f4f6; 
        border-radius: 8px 8px 0 0; 
        border: 1px solid var(--border-color); 
        border-bottom: none;
        font-weight: bold; 
        color: #4b5563; 
        transition: all 0.2s ease;
        opacity: 0.9;
        user-select: none; 
        -webkit-user-select: none;
    }

    .tab:hover { opacity: 1; background: #e5e7eb; }

    /* 啟用狀態的 Tab 樣式，並根據 data-bsc 屬性變換上方框線顏色 */
    .tab.active { 
        background: #fff; 
        color: #111827; 
        opacity: 1;
        box-shadow: 0 -3px 6px rgba(0,0,0,0.05); 
        border-bottom: 2px solid #fff; 
        padding-top: 10px; 
        margin-top: -2px;
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
        border-top: 1px solid var(--border-color);
    }
    
    .tab[data-bsc="1"].active { border-top: 4px solid var(--bsc1-color); color: var(--bsc1-color); }
    .tab[data-bsc="2"].active { border-top: 4px solid var(--bsc2-color); color: var(--bsc2-color); }
    .tab[data-bsc="3"].active { border-top: 4px solid var(--bsc3-color); color: var(--bsc3-color); }
    .tab[data-bsc="4"].active { border-top: 4px solid var(--bsc4-color); color: var(--bsc4-color); }

    /* 表格主要外框 */
    .table-card { 
        background: #fff; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        border-top-left-radius: 0; 
        padding: 0; 
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        height: auto; 
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
        position: relative;
        z-index: 5;
    }

    /* 標題與按鈕工具列 */
    .info-bar {
        padding: 8px 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        border-bottom: 1px solid var(--inner-border-color); 
        background: #fff;
        flex-shrink: 0;
    }

    /* CSS Grid 網格佈局控制 (核心預約表) */
    .grid-wrapper {
        height: auto; 
        max-height: 85vh; 
        overflow: auto; 
        display: grid;
        grid-template-columns: 100px repeat(14, 1fr); /* 時間軸 100px + 14 天等分欄位 */
        grid-auto-rows: 40px; 
        position: relative;
        user-select: none;
        -webkit-user-select: none; 
    }

    /* 儲存格通用樣式 */
    .grid-cell {
        border-right: 1px solid var(--inner-border-color); 
        border-bottom: 1px solid var(--inner-border-color);
        display: flex; align-items: center; justify-content: center;
        font-size: var(--grid-font-size); position: relative;
        box-sizing: border-box; 
    }

    /* 固定表頭 (Sticky Header) */
    .header-cell { color: white; font-weight: bold; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    /* 表格左上角交叉儲存格 */
    .corner-cell { 
        background: #f9fafb; color: #374151; position: sticky; top: 0; left: 0; z-index: 20; 
        font-weight: bold;
        border-bottom: 1px solid var(--inner-border-color); 
        border-right: 1px solid var(--border-color); 
    }
    
    /* 左側固定時間標籤 */
    .time-label { 
        background: #f9fafb; font-weight: bold; color: #6b7280; position: sticky; left: 0; z-index: 5; font-size: 12px; 
        border-right: 1px solid var(--border-color);
    }

    /* 可互動的預約時段單元格 */
    .slot-cell { 
        cursor: cell; background: #fff; padding: 0 5px; white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; display: block; 
        line-height: 40px; 
        text-align: center;
        transition: background-color 0.1s;
    }
    .slot-cell:hover { background-color: #f8fafc; }

    /* 預約狀態樣式 */
    .booked-cell { background: #fee2e2 !important; color: #991b1b !important; font-weight: bold; } /* 已被預約 */
    .my-cell { background: #fef9c3 !important; color: #854d0e !important; border: 2px solid #facc15 !important; } /* 我的預約 */
    
    /* 滑鼠拖曳選取中的樣式 */
    .selecting { 
        background: #bae6fd !important; 
        outline: none; 
        z-index: 2; 
    }

    /* 當前小時的儲存格特別標示 */
    .slot-cell.is-now { 
        background-color: #eff6ff !important; 
        border: 2px solid var(--now-border) !important;
        z-index: 8;
    }
    
    .slot-cell.is-now.selecting {
        background-color: #bae6fd !important;
        z-index: 9; 
    }

    /* 「Now」標籤文字樣式 */
    .now-tag {
        position: absolute; width: 100%; text-align: center; font-weight: 900;
        color: var(--now-border); pointer-events: none; bottom: 2px; font-size: 10px; line-height: 1;
    }

    /* 強制底部間距填充 */
    .bottom-padding-force {
        height: 20px; 
        width: 100%;
        background: transparent;
        grid-column: 1 / span 15;
    }
</style>

<div class="full-page-wrapper">
    
    <div class="tab-container">
        {% for i in range(1, 5) %}
        <div class="tab {{ 'active' if i == 1 }}" data-bsc="{{ i }}" onclick="openTab(event, 'bsc{{ i }}')">BSC {{ i }}</div>
        {% endfor %}
    </div>

    <div class="table-card">
        <div class="info-bar">
            <span id="table-title" style="font-size: 16px; font-weight: bold; color: var(--bsc1-color);">BSC 1 預約表 / Booking Table</span>
            <button id="submit-btn" onclick="submitBatch()" style="background: var(--bsc1-color); color: white; padding: 8px 24px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: opacity 0.2s;">送出變更 / Submit</button>
        </div>

        {% for bsc_id in range(1, 5) %}
        <div id="bsc{{ bsc_id }}" class="tab-content" style="display: {{ 'block' if bsc_id == 1 else 'none' }}; height: auto;">
            <div class="bsc-responsive-container" style="height: auto; display: flex; flex-direction: column;">
                <div class="grid-wrapper">
                    <div class="grid-cell corner-cell">時間 / Time</div>
                    {% for d in dates %}
                    <div class="grid-cell header-cell" style="background-color: var(--bsc{{ bsc_id }}-color);">
                        <div style="text-align: center;">
                            <div style="font-size: 12px;">{{ d.strftime('%m/%d') }}</div>
                            <div style="font-size: 10px; font-weight: normal; opacity: 0.9;">週{{ "一二三四五六日"[d.weekday()] }}</div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for h in range(6, 22) %}
                        <div class="grid-cell time-label">{{ "%02d:00" | format(h) }}-{{ "%02d:00" | format(h+1) }}</div>
                        {% for d in dates %}
                            {% set slot_key = (d, h) %}
                            {% set res_user = booked[bsc_id].get(slot_key, "") %}
                            <div class="grid-cell slot-cell {{ 'booked-cell' if res_user }} {{ 'my-cell' if res_user == current_user }}"
                                  data-bsc="{{ bsc_id }}" data-date="{{ d.strftime('%Y-%m-%d') }}" data-slot="{{ h }}"
                                  data-owner="{{ 'me' if res_user == current_user else ('others' if res_user else 'none') }}"
                                  title="{{ res_user }}">
                                {{ res_user }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                    
                    <div class="bottom-padding-force"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    let isMouseDown = false;
    let mode = null; // 決定目前動作是「預約(reserve)」或「取消(cancel)」
    let selectedSlots = new Set(); // 記錄目前被框選的時段組合

    // 初始化滑鼠選取功能：支援滑鼠按下並拖曳選取
    function initSelection() {
        document.querySelectorAll('.slot-cell').forEach(cell => {
            cell.addEventListener('mousedown', (e) => {
                // 檢查是否有登入使用者
                if ("{{ current_user }}" === "") return alert("請先選取使用者！");
                
                isMouseDown = true;
                const owner = cell.dataset.owner;
                
                // 邏輯判定：點擊空白處則為預約，點擊自己的區域則為取消
                if (owner === 'none') mode = 'reserve';
                else if (owner === 'me') mode = 'cancel';
                else { isMouseDown = false; return; } // 他人的預約不能選取
                
                toggleCell(cell);
            });
            cell.addEventListener('mouseenter', () => {
                // 滑鼠拖曳經過時持續變更狀態
                if (isMouseDown && mode) toggleCell(cell);
            });
        });
    }

    // 全域監聽滑鼠放開，停止選取
    document.addEventListener('mouseup', () => { isMouseDown = false; });

    // 切換儲存格的選取視覺狀態
    function toggleCell(cell) {
        const id = `${cell.dataset.bsc}|${cell.dataset.date}|${cell.dataset.slot}`;
        const owner = cell.dataset.owner;
        
        // 確保操作符合當前的模式 (不能混雜預約與取消)
        if ((mode === 'reserve' && owner === 'none') || (mode === 'cancel' && owner === 'me')) {
            if (selectedSlots.has(id)) {
                selectedSlots.delete(id);
                cell.classList.remove('selecting');
            } else {
                selectedSlots.add(id);
                cell.classList.add('selecting');
            }
        }
    }

    // 取得當前電腦時間並在畫面上標記「Now」
    function markCurrentTime() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const todayStr = `${y}-${m}-${d}`;
        const currentHour = now.getHours();

        document.querySelectorAll('.slot-cell').forEach(cell => {
            cell.classList.remove('is-now');
            const tag = cell.querySelector('.now-tag');
            if (tag) tag.remove();

            // 若日期與小時皆相符，則加上視覺標記
            if (cell.dataset.date === todayStr && parseInt(cell.dataset.slot) === currentHour) {
                cell.classList.add('is-now');
                const tagSpan = document.createElement('div');
                tagSpan.className = 'now-tag';
                tagSpan.innerText = 'Now';
                cell.appendChild(tagSpan);
            }
        });
    }

    // 將選取的時段打包成 JSON 並發送至後端 API
    async function submitBatch() {
        if (selectedSlots.size === 0) return alert("尚未選取任何時段");
        const data = Array.from(selectedSlots).map(s => {
            const [bsc, date, slot] = s.split('|');
            return { bsc, date, slot, mode };
        });
        const response = await fetch('/bsc_batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: data })
        });
        if (response.ok) window.location.reload(); // 完成後重新載入頁面同步資料
    }

    // 切換 BSC 分頁的顯示邏輯
    function openTab(evt, tabId) {
        // 切換面板顯示
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
        document.querySelectorAll('.tab').forEach(t => t.classList.remove("active"));
        document.getElementById(tabId).style.display = "block";
        evt.currentTarget.classList.add("active");
        
        // 動態變更 UI 顏色 (與 BSC 配色一致)
        const bscNum = tabId.replace('bsc', '');
        const title = document.getElementById('table-title');
        const submitBtn = document.getElementById('submit-btn');
        const activeColor = getComputedStyle(document.documentElement).getPropertyValue(`--bsc${bscNum}-color`).trim();
        
        title.innerText = `BSC ${bscNum} 預約表 / Booking Table`;
        title.style.color = activeColor;
        submitBtn.style.background = activeColor;
        
        // 切換頁面時自動清空目前暫存的選取狀態，防止誤送
        selectedSlots.clear();
        document.querySelectorAll('.slot-cell').forEach(c => c.classList.remove('selecting'));
    }

    // 啟動功能
    initSelection();
    markCurrentTime();
    // 每 30 秒自動更新一次「Now」標籤的位置
    setInterval(markCurrentTime, 30000);
</script>
{% endblock %}
